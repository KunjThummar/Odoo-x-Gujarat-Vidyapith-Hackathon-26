generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  FLEET_MANAGER
  DISPATCHER
  SAFETY_OFFICER
  FINANCIAL_ANALYST
  DRIVER
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  IN_SHOP
}

enum TripStatus {
  DRAFT
  DISPATCHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model User {
  id        Int      @id @default(autoincrement())
  fullName  String
  email     String   @unique
  password  String
  phone     String?  @unique
  role      Role     @default(DRIVER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver             Driver?
  managedDispatchers Dispatcher[]     @relation("ManagerDispatchers")
  tripsAsDriver      Trip[]           @relation("DriverTrips")
  tripsCreated       Trip[]           @relation("CreatedByTrips")
  fuelLogs           FuelLog[]
  expenses           Expense[]
  maintenanceLogs    MaintenanceLog[]

  @@index([email])
  @@map("users")
}

model Driver {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  licenseNumber  String   @unique
  licenseExpiry  DateTime
  safetyScore    Float    @default(100)
  status         String   @default("On Duty")
  totalTrips     Int      @default(0)
  completionRate Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([licenseNumber])
  @@map("drivers")
}

model Vehicle {
  id              Int           @id @default(autoincrement())
  vehicleName     String
  model           String
  licensePlate    String        @unique
  type            String        @default("Truck")
  maxLoadCapacity Float
  odometer        Float         @default(0)
  status          VehicleStatus @default(AVAILABLE)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  trips           Trip[]
  maintenanceLogs MaintenanceLog[]
  fuelLogs        FuelLog[]

  @@index([licensePlate])
  @@map("vehicles")
}

model Trip {
  id            Int        @id @default(autoincrement())
  tripType      String     @default("Delivery")
  origin        String
  destination   String
  cargoWeight   Float
  estimatedFuel Float?
  status        TripStatus @default(DRAFT)
  vehicleId     Int?
  driverId      Int?
  createdById   Int
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  vehicle   Vehicle?  @relation(fields: [vehicleId], references: [id])
  driver    User?     @relation("DriverTrips", fields: [driverId], references: [id])
  createdBy User      @relation("CreatedByTrips", fields: [createdById], references: [id])
  expenses  Expense[]

  @@index([status])
  @@index([driverId])
  @@map("trips")
}

model MaintenanceLog {
  id          Int      @id @default(autoincrement())
  vehicleId   Int
  issue       String
  service     String
  date        DateTime @default(now())
  cost        Float    @default(0)
  completed   Boolean  @default(false)
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])
  createdBy User    @relation(fields: [createdById], references: [id])

  @@map("maintenance_logs")
}

model FuelLog {
  id           Int      @id @default(autoincrement())
  vehicleId    Int
  driverId     Int?
  liters       Float
  costPerLiter Float
  totalCost    Float
  odometer     Float
  date         DateTime @default(now())
  createdAt    DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
  driver  User?   @relation(fields: [driverId], references: [id])

  @@map("fuel_logs")
}

model Expense {
  id          Int      @id @default(autoincrement())
  tripId      Int?
  category    String
  amount      Float
  description String?
  date        DateTime @default(now())
  createdById Int
  createdAt   DateTime @default(now())

  trip      Trip? @relation(fields: [tripId], references: [id])
  createdBy User  @relation(fields: [createdById], references: [id])

  @@map("expenses")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  email     String
  otp       String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@map("password_reset_tokens")
}

model Dispatcher {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  phone     String
  managerId Int
  manager   User     @relation("ManagerDispatchers", fields: [managerId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dispatchers")
}
